<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Real-Time Navigation</title>
    <script src="https://api.mapbox.com/mapbox-gl-js/v2.14.0/mapbox-gl.js"></script>
    <link
      href="https://api.mapbox.com/mapbox-gl-js/v2.14.0/mapbox-gl.css"
      rel="stylesheet"
    />
    <style>
      body {
        margin: 0;
        padding: 0;
        font-family: Arial, sans-serif;
      }
      #map {
        width: 100vw;
        height: 100vh;
        overflow: hidden;
      }

      /* Sidebar Panel */
      #nav-panel {
        position: absolute;
        top: 20px;
        right: 10px;
        width: 250px;
        background: rgba(0, 0, 0, 0.8);
        color: white;
        padding: 15px;
        border-radius: 10px;
        font-size: 14px;
        transition: transform 0.3s ease-in-out;
        overflow: hidden;
      }

      /* Minimized Panel */
      #nav-panel.hidden {
        transform: translateX(270px);
        overflow: hidden;
      }

      .step {
        padding: 8px;
        margin-bottom: 5px;
        background: #222;
        border-radius: 5px;
      }
      .current-step {
        background: #007aff;
      }

      /* Toggle Button */
      #toggle-btn {
        position: absolute;
        top: 20px;
        right: 270px;
        background: #007aff;
        color: white;
        padding: 8px 12px;
        border-radius: 5px;
        border: none;
        cursor: pointer;
        transition: right 0.3s ease-in-out;
      }

      /* When panel is hidden, move button */
      #nav-panel.hidden + #toggle-btn {
        right: 10px;
      }
    </style>
  </head>
  <body>
    <div id="map"></div>

    <!-- Navigation Panel -->
    <div id="nav-panel">
      <h3>Real-time Travel Time</h3>
      <p id="eta">Calculating...</p>
      <h3>Route Steps</h3>
      <div id="steps"></div>
    </div>

    <!-- Toggle Button -->
    <button id="toggle-btn">◀ Hide</button>

    <script>
      mapboxgl.accessToken =
        "pk.eyJ1IjoiYW1hc2hhcnUiLCJhIjoiY204cmY4am1vMHV3ZjJqczhjcWpueGFhaSJ9.EpsIRkNxnpw4i8w1oSOQYw"; // Replace with your token

      const start = [120.87383, 14.828492];
      const end = [121.035315, 14.653648];
      let vehiclePos = [...start];

      const map = new mapboxgl.Map({
        container: "map",
        style: "mapbox://styles/mapbox/navigation-night-v1",
        center: start,
        zoom: 12,
      });

      const vehicle = new mapboxgl.Marker({ color: "blue" })
        .setLngLat(vehiclePos)
        .addTo(map);
      new mapboxgl.Marker({ color: "red" }).setLngLat(end).addTo(map);

      async function getRoute() {
        const url = `https://api.mapbox.com/directions/v5/mapbox/driving/${start[0]},${start[1]};${end[0]},${end[1]}?geometries=geojson&steps=true&overview=full&access_token=${mapboxgl.accessToken}`;

        try {
          const response = await fetch(url);
          const data = await response.json();
          if (!data.routes || data.routes.length === 0) {
            throw new Error("No route found.");
          }

          const route = data.routes[0];
          const coordinates = route.geometry.coordinates;
          const steps = route.legs[0].steps;
          let remainingDuration = Math.round(route.duration / 60);
          document.getElementById("eta").innerText = `${remainingDuration} min`;

          map.addSource("route", {
            type: "geojson",
            data: {
              type: "Feature",
              geometry: { type: "LineString", coordinates },
            },
          });

          map.addLayer({
            id: "route-layer",
            type: "line",
            source: "route",
            layout: { "line-join": "round", "line-cap": "round" },
            paint: {
              "line-color": "#007aff",
              "line-width": 6,
              "line-opacity": 0.5,
            },
          });

          const stepsContainer = document.getElementById("steps");
          stepsContainer.innerHTML = "";
          steps.forEach((step, index) => {
            const stepElement = document.createElement("div");
            stepElement.classList.add("step");
            stepElement.dataset.index = index;
            stepElement.innerHTML = `<strong>${step.distance.toFixed(
              1
            )} m</strong> - ${step.name || "Unnamed road"}`;
            stepsContainer.appendChild(stepElement);
          });

          let index = 0;
          function moveVehicle() {
            if (index < coordinates.length) {
              vehiclePos = coordinates[index];
              vehicle.setLngLat(vehiclePos);
              remainingDuration = Math.max(0, remainingDuration - 1);
              document.getElementById(
                "eta"
              ).innerText = `${remainingDuration} min`;

              let currentStep = steps.find((step) => {
                return (
                  Math.abs(step.maneuver.location[0] - vehiclePos[0]) <
                    0.0001 &&
                  Math.abs(step.maneuver.location[1] - vehiclePos[1]) < 0.0001
                );
              });

              document
                .querySelectorAll(".step")
                .forEach((el) => el.classList.remove("current-step"));
              if (currentStep) {
                let currentIndex = steps.indexOf(currentStep);
                let currentStepElement = document.querySelector(
                  `.step[data-index="${currentIndex}"]`
                );
                if (currentStepElement) {
                  currentStepElement.classList.add("current-step");
                  currentStepElement.scrollIntoView({
                    behavior: "smooth",
                    block: "center",
                  });
                }
              }

              index++;
              setTimeout(moveVehicle, 1000);
            }
          }

          moveVehicle();
        } catch (error) {
          console.error("Error loading route:", error);
          alert("Failed to load route. Check your Mapbox access token.");
        }
      }

      map.on("load", getRoute);

      // Toggle Panel Visibility
      const panel = document.getElementById("nav-panel");
      const toggleBtn = document.getElementById("toggle-btn");

      toggleBtn.addEventListener("click", () => {
        panel.classList.toggle("hidden");
        toggleBtn.innerText = panel.classList.contains("hidden")
          ? "▶ Show"
          : "◀ Hide";
      });
    </script>
  </body>
</html>
